<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学生主页</title>
    <style>
       body {
            margin: 0;
            font-family: Arial, sans-serif;
        }

        .navbar {
            background-color: #0b0c0b;
            padding: 10px;
            border-bottom: 2px solid #212321;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .navbar-left,
        .navbar-right {
            display: flex;
            align-items: center; /* 确保所有元素垂直居中 */
        }

        .navbar-left {
            flex: 1;
        }

        .navbar-right {
            margin-left: auto;
        }

        .navbar-nav {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
        }

        .navbar-nav li {
            margin: 0;
        }

        .navbar-nav a {
            color: white;
            text-decoration: none;
            padding: 14px 20px;
            display: block;
            text-align: center;
            border-radius: 4px;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }

        .navbar-nav a:hover {
            background-color: #423673;
            transform: scale(1.05);
        }

        .logout-button {
            background-color: #f44336;
            padding: 10px 20px;
            border-radius: 4px;
            text-decoration: none;
            color: white;
            margin-left: 10px; /* 增加与用户名之间的间距 */
        }

        .logout-button:hover {
            background-color: #d32f2f;
        }

        .username {
            color: white; /* 设置用户名的字体颜色为白色 */
            margin-right: 10px; /* 增加与退出按钮之间的间距 */
        }

        .content {
            padding: 20px;
        }
        /* 图书列表样式 */
        #books-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            padding: 20px;
        }

        .book-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 200px;
            padding: 10px;
            text-align: center;
        }

        .book-card img {
            max-width: 100%;
            border-radius: 8px;
        }

        .book-card h2 {
            font-size: 16px;
            margin: 10px 0;
        }

        .book-card p {
            font-size: 14px;
            color: #666;
        }

        .button-detail {
            background-color: #e6e6e6; /* 灰色背景 */
            border: 0.5px solid #000; /* 黑色边框 */
            color: #000; /* 文字颜色 */
            padding: 5px 10px; /* 内边距 */
            text-align: center; /* 文字居中 */
            font-size: 10px; /* 字体大小 */
            cursor: pointer; /* 鼠标悬停时显示为指针 */
            border-radius: 4px; /* 圆角边框 */
        }

        .button-detail:hover {
            background-color: #cecece; /* 鼠标悬停时的背景色 */
        }

        /* 模态框样式 */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9998; /* 较低的z-index值，使得遮罩层位于模态框下方 */
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
        }

        #bookModal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 9999; /* 提高模态框的层级，使其位于其他元素之上 */
            display: none;
            background-color: transparent;
        }

        .modal-dialog {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .modal-title {
            margin: 0;
        }

        .close {
            background: none;
            border: none;
            cursor: pointer;
        }

        .modal-body {
            text-align: left;
        }

        .modal-body p {
            margin-bottom: 5px;
        }

        .borrow-button {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-left">
            <ul class="navbar-nav">
                <li><a href="/static/student_index.html">首页</a></li>
                <li><a href="/static/stu_information.html">个人信息</a></li>
                <li><a href="/static/stu_borrows.html">个人借阅</a></li>
            </ul>
        </div>
        <div class="navbar-right">
            <!-- 添加显示用户名的元素 -->
            <span class="username" id="username-display"></span>
            <a href="/static/logout.html" class="logout-button">退出登录</a>
        </div>
    </nav>

    <div class="content">
        <div id="books-container">
            <!-- 图书列表将插入到这里 -->
        </div>
    </div>

    <!-- 遮罩层 -->
    <div class="modal-backdrop"></div>

    <!-- 模态框 -->
    <div id="bookModal" class="modal" style="display: none;">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">图书详情</h4>
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                <div class="modal-body">
                    <!-- 添加图片显示 -->
                    <img id="modalPicture" src="" alt="封面图片" style="max-width: 300px; max-height: 400px; margin-bottom: 10px; display: block; margin-left: auto; margin-right: auto;">
                    <p id="modalTitle">标题</p>
                    <p id="modalAuthor">作者</p>
                    <p id="modalPublisher">出版社</p>
                    <p id="modalPages">页数</p>
                    <p id="modalDescription">描述</p>
                    <label for="borrowDays">借阅天数（1-90天）:</label>
                    <input type="number" id="borrowDays" min="1" max="90">
                    <button class="borrow-button" id="borrowButton">借阅</button>
                </div>
            </div>
        </div>
    </div>

    <script>

        // 检查 JWT 存储
        const token = localStorage.getItem('access_token');
        if (!token) {
            location.href = '/static/student_login.html'; // 没有登录就自动跳转到登录页面
        } else {

    document.addEventListener('DOMContentLoaded', function () {
    // 获取用户名并显示
    const username = localStorage.getItem('username'); 
    console.log(username);
    document.getElementById('username-display').textContent = `欢迎, ${username}`;

    let currentBook = null;
    let invalidInputAlertShown = false; // 添加标志变量

    function fetchBooks() {
        const url = 'http://localhost:8090/books/all'; // Ensure this URL matches your Flask route

        fetch(url)
            .then(response => response.json())
            .then(data => {
                displayBooks(data);
            })
            .catch(error => {
                console.error('Error fetching books:', error);
            });
    }

    function displayBooks(books) {
        const container = document.getElementById('books-container');
        container.innerHTML = '';

        books.forEach(book => {
            const bookCard = document.createElement('div');
            bookCard.className = 'book-card';

            bookCard.innerHTML = `
                <img src="/static/images/${book.picture || 'placeholder.jpg'}" alt="${book.title}">
                <h2>${book.title}</h2>
                <p>作者: ${book.author}</p>
                <p>出版社: ${book.publisher}</p>
                <p>页数: ${book.pages}页</p>
                <p><button class="button-detail" data-book-id="${book.bid}">详情</button></p>
            `;

            container.appendChild(bookCard);

            // 为每个详情按钮添加事件监听器
            bookCard.querySelector('.button-detail').addEventListener('click', function (event) {
                event.preventDefault();
                currentBook = book;
                showModal();
            });
        });
    }

    function showModal() {
        document.getElementById('bookModal').style.display = 'flex';
        document.querySelector('.modal-backdrop').style.display = 'block';
        document.getElementById('modalTitle').textContent = `标题: ${currentBook.title}`;
        document.getElementById('modalAuthor').textContent = `作者: ${currentBook.author}`;
        document.getElementById('modalPublisher').textContent = `出版社: ${currentBook.publisher}`;
        document.getElementById('modalPages').textContent = `页数: ${currentBook.pages}页`;
        document.getElementById('modalDescription').textContent = `描述: ${currentBook.description || '无描述'}`;

        // 设置封面图片的 src 属性
    const pictureUrl = `/static/images/${currentBook.picture || 'placeholder.jpg'}`;
    document.getElementById('modalPicture').src = pictureUrl;

        // 为关闭按钮添加事件监听器
        document.querySelector('.modal-dialog .close').addEventListener('click', hideModal);

        // 为借阅按钮添加事件监听器
        document.getElementById('borrowButton').addEventListener('click', function () {
            const days = parseInt(document.getElementById('borrowDays').value);
            if (isNaN(days) || days < 1 || days > 90) {
                if (!invalidInputAlertShown) { // 只有当标志为假时才显示提示
                    alert('请输入有效的借阅天数（1-90天）');
                    invalidInputAlertShown = true; // 设置标志为真
                }
                return;
            }
            borrowBook(currentBook.bid, days);
        });
    }

    function hideModal() {
        document.getElementById('bookModal').style.display = 'none';
        document.querySelector('.modal-backdrop').style.display = 'none';
        invalidInputAlertShown = false; // 重置标志变量，以便下次输入时重新启用提示
    }

    function borrowBook(bookId, days) {
        const url = `http://localhost:8090/books/borrow/${bookId}?days=${days}`;

        fetch(url, {
            method: 'POST'
        })
            .then(response => {
                if (response.ok) {
                    alert('借阅成功！');
                    hideModal();
                    fetchBooks(); // 刷新图书列表
                } else {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
            })
            .catch(error => {
                console.error('Error borrowing book:', error);
                alert('借阅失败，请稍后再试！');
            });
    }

    // Fetch books when page loads
    fetchBooks();
});

}
</script>

</body>

</html>